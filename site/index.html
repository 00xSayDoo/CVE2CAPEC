<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-sankey.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <title>CVE2CAPEC</title>
    <style>
        html {
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            height: 100%;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 24px;
            margin-bottom: 2%;
        }

        .column {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-height: 200px;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        #container {
            height: 100%;
            margin-left: 3%; 
            margin-top: 2%; 
            margin-right: 3%;
            margin-bottom: 5%;
        }


    </style>
</head>
<body>

    <header>
        CVE2CAPEC
    </header>

    <main>
        <div class="page-inner" id="inner">
            <div class="row" style="margin-left: 2%; margin-right: 2%;">
                <div class="col-md-12">
                    <h3 style="text-align: center;">list of CVEs</h3>
                    <div class="card column">
                        <div class="card-body" contenteditable="true" id="cves">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-left: 2%; margin-right: 2%;">
                <div class="col-md-12" id="process_button" style="text-align: center;">
                    <button type="button" class="btn btn-primary" style="margin-top: 2%; width: 50%;" onclick="process()">Process</button>
                </div>
            </div>
        </div>
    </main>
    <div id="container"></div>

    <footer>
        Made with ‚ù§Ô∏è in France üá´üá∑ by <a href="https://galeax.com/">Galeax</a>
    </footer>
</body>

<script>
    var metrics = {"CWE": {}, "CAPEC": {}, "TECHNIQUES": {}};
    var data_cleaned = [];

    var chart = anychart.sankey();

    // set the chart's padding
    chart.padding(20, 40);
    
    // add a title
    chart.title('CVEs data flow');

    // set the chart container id
    chart.container('container');

    // Adjust the chart size dynamically
    chart.bounds(0, 0, '100%', '100%');

    // Avoid Copy/Paste formatting in contenteditable div
    document.querySelector('[contenteditable]').addEventListener('paste', function (event) {
        event.preventDefault();
        document.execCommand('inserttext', false, event.clipboardData.getData('text/plain'));
    });


    async function process() {
        data_cleaned = [];
        metrics = {"CWE": {}, "CAPEC": {}, "TECHNIQUES": {}};
        var cves_not_found = [];
        var cves = document.getElementById('cves').innerText.trim();
        if (!cves) {
            Swal.fire({
                icon: 'warning',
                title: 'No CVEs found',
                text: 'Please enter some CVEs.',
            });
            return;
        }

        var cves_array = cves.split('\n').map(cve => cve.trim()).filter(cve => cve !== '');

        // Group by year
        var cves_list = {};
        for (var i = 0; i < cves_array.length; i++) {
            var cve = cves_array[i];
            var year = cve.split('-')[1];
            if (!cves_list[year]) {
                cves_list[year] = [];
            }
            cves_list[year].push(cve);
        }

        var data = [];

        for (var year in cves_list) {
            var cves = cves_list[year];
            try {
                var response = await fetch(`https://raw.githubusercontent.com/Galeax/CVE2CAPEC/refs/heads/main/database/CVE-${year}.jsonl`);
                var responseText = await response.text();
            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'An error occurred',
                    text: 'Failed to fetch the database for year ' + year,
                });
                continue; // Skip this year if there is an error
            }

            // Parse JSONL file content
            var database = {};
            responseText.split('\n').forEach(line => {
                if (line.trim()) {
                    try {
                        var data = JSON.parse(line);
                        database[Object.keys(data)[0]] = data[Object.keys(data)[0]];
                    } catch (parseError) {
                        console.error('Error parsing JSON line:', line);
                    }
                }
            });
            
            try {
                var [cwe_data, capec_data_raw] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/Galeax/CVE2CAPEC/refs/heads/main/resources/cwe_db.json').then(res => res.text()),
                    fetch('https://raw.githubusercontent.com/Galeax/CVE2CAPEC/refs/heads/main/resources/capec_db.json').then(res => res.text())
                ]);
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'An error occurred',
                    text: 'Failed to fetch the CWE or CAPEC database',
                });
                return;
            }
            
            capec_data_raw = JSON.parse(capec_data_raw);
            var techniques_data = capec_data_raw;
            Object.keys(capec_data_raw).forEach(technique => {
                var technics = new Set();
                var lines = capec_data_raw[technique]['techniques'].split("NAME:ATTACK:ENTRY ")
                for (var i = 1; i < lines.length; i++) {
                    var line = lines[i];
                    var technique_id = line.split(":")[1];
                    technics.add(technique_id);
                }
                techniques_data[technique]["techniques"] = Array.from(technics);
            });

            for (var i = 0; i < cves.length; i++) {
                var cve = cves[i];
                if (!database[cve]) {
                    cves_not_found.push(cve);
                    continue;
                }
                var cwes = database[cve]['CWE'];
                var capecs = database[cve]['CAPEC'];
                var techniques = database[cve]['TECHNIQUES'];
                for (var j = 0; j < cwes.length; j++) {
                    var cwe = cwes[j];
                    var node = {
                        "from": cve,
                        "to": "CWE-"+cwe,
                        "value": 1
                    };
                    data.push(node);
                    var capec_data = JSON.parse(cwe_data)
                    if (capec_data[cwe]) {
                        var capecs = capec_data[cwe]["RelatedAttackPatterns"];
                        if (capecs.length > 0) {
                            for (var k = 0; k < capecs.length; k++) {
                                var capec = capecs[k];
                                var node = {
                                    "from": "CWE-"+cwe,
                                    "to": "CAPEC-"+capec,
                                    "value": 1
                                };                                
                                data.push(node);
                                if (techniques_data[capec]) {
                                    var techniques = techniques_data[capec]["techniques"];
                                    if (techniques.length > 0) {
                                        for (var l = 0; l < techniques.length; l++) {
                                            var technique = techniques[l];
                                            var node = {
                                                "from": "CAPEC-"+capec,
                                                "to": "T"+technique,
                                                "value": 1
                                            };
                                            data.push(node);
                                        }
                                    } else {
                                        var node = {
                                            "from": "CAPEC-"+capec,
                                            "to": null,
                                            "value": 1
                                        };
                                        data.push(node);
                                    }
                                }
                            }
                        } else {
                            var node = {
                                "from": "CWE-"+cwe,
                                "to": null,
                                "value": 1
                            };
                            data.push(node);/*
                            node = {
                                "from": "CAPEC-N/A",
                                "to": null,
                                "value": 1
                            };
                            data.push(node);*/
                        }
                    }
                }            
            }
        }
        // Remove duplicates
        for (var i = 0; i < data.length; i++) {
            var node = data[i];
            var found = false;
            for (var j = 0; j < data_cleaned.length; j++) {
                var node2 = data_cleaned[j];
                if (node.from === node2.from && node.to === node2.to) {
                    node2.value++;
                    found = true;
                    break;
                }
            }
            if (!found) {
                data_cleaned.push(node);
            }
        }

        chart.data(data_cleaned);
        chart.maxHeight('100%');
        chart.draw();

        await create_mitre_layer();

        var orga = document.getElementById('inner');
        if (!document.getElementById('control_row')) {
            var control_row = document.createElement('div');
            control_row.className = 'row';
            control_row.id = 'control_row';
            orga.appendChild(control_row);

            var download_button = document.createElement('div');
            download_button.className = 'col-md-6';
            download_button.style.textAlign = 'center';
            download_button.innerHTML = '<button type="button" class="btn btn-primary" style="margin-top: 2%; width: 50%;" onclick="download_layer()" id="download_button">Download MITRE ATT&CK Layer</button>';
            control_row.appendChild(download_button);

            var mitre_button = document.createElement('div');
            mitre_button.className = 'col-md-6';
            mitre_button.style.textAlign = 'center';
            mitre_button.innerHTML = '<button type="button" class="btn btn-primary" style="margin-top: 2%; width: 50%;" onclick="window.open(\'/mitre/\', \'_blank\')" id="mitre_buton">Open MITRE ATT&CK Navigator</button>';
            control_row.appendChild(mitre_button);
        }

        if (cves_not_found.length > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Some CVEs not found',
                text: 'The following CVEs were not found in the database: ' + cves_not_found.join(', '),
            });
        }
    }


    async function create_mitre_layer() {
        var data_layer = {};
        
        // Get the list of techniques, some node.to maybe null
        var techniques_list = data_cleaned.filter(node => node.to !== null);
        console.log(techniques_list);
        var max_score = 0;


        for (var i = 0; i < techniques_list.length; i++) {
            var element = techniques_list[i];
            var technique = element.to;
            var score = element.value;
            if (!data_layer[technique]) {
                data_layer[technique] = score;
            } else {
                data_layer[technique] += score;
            }
        }

        var tmp = Object.assign({}, data_layer);
        for (var key in tmp) {
            // si la cl√© match avec T\d+\.\d+ alors on ajoute la valeur √† la cl√© parente
            if (key.match(/T\d+\.\d+/)) {
                var parent = key.split('.')[0];
                if (data_layer[parent]) {
                    data_layer[parent] += data_layer[key];
                } else {
                    data_layer[parent] = data_layer[key];
                }
            }
        }
        
        // Calculate the max score, max score is the highest score of a technique or subtechnique
        for (var key in data_layer) {
            var score = data_layer[key];
            if (score > max_score) {
                max_score = score;
            }
        }

        var layer = {
            "name": "CVE2CAPEC - New CVEs layer",
            "versions": {
                "attack": "15",
                "navigator": "5.1.0",
                "layer": "4.5"
            },
            "domain": "enterprise-attack",
            "description": "",
            "filters": {
                "platforms": [
                    "Windows",
                    "Linux",
                    "macOS",
                    "Network",
                    "PRE",
                    "Containers",
                    "Office 365",
                    "SaaS",
                    "Google Workspace",
                    "IaaS",
                    "Azure AD"
                ]
            },
            "sorting": 3,
            "layout": {
                "layout": "side",
                "aggregateFunction": "average",
                "showID": false,
                "showName": true,
                "showAggregateScores": false,
                "countUnscored": false,
                "expandedSubtechniques": "none"
            },
            "hideDisabled": false,
            "techniques": [],
            "gradient": {
                "colors": [
                    "#ffe766ff",
                    "#ff9558",
                    "#ff6666ff"
                ],
                "minValue": 0,
                "maxValue": max_score
            },
            "legendItems": [],
            "metadata": [],
            "links": [],
            "showTacticRowBackground": false,
            "tacticRowBackground": "#dddddd",
            "selectTechniquesAcrossTactics": true,
            "selectSubtechniquesWithParent": false,
            "selectVisibleTechniques": false,
        };

        try {
            var response = await fetch('https://raw.githubusercontent.com/Galeax/CVE2CAPEC/refs/heads/main/resources/techniques_db.json');
            var responseText = await response.text();
        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'An error occurred',
                text: 'Failed to fetch the techniques database',
            });
            return;
        }

        var techniques_db = JSON.parse(responseText);

        for (var key in data_layer) {
            var tactics = techniques_db[key];
            if (!tactics) {
                continue;
            }
            for (var j = 0; j < tactics.length; j++) {
                var tactic = tactics[j];
                var row = {
                    "techniqueID": key,
                    "tactic": tactic.toLowerCase().replace(' ', '-'),
                    "color": "",
                    "comment": "",
                    "enabled": true,
                    "metadata": [],
                    "links": [],
                    "showSubtechniques": false
                };
                if (data_layer[key] > 0) {
                    row["score"] = data_layer[key];
                }
                layer.techniques.push(row);
            }
        }

        localStorage.setItem('layer', JSON.stringify(layer));


    }

    async function download_layer() {
        var layer = localStorage.getItem('layer');
        if (!layer) {
            Swal.fire({
                icon: 'warning',
                title: 'No layer found',
                text: 'Please create a layer first.',
            });
            return;
        }
        var blob = new Blob([layer], {type: 'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'layer.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }

</script>

</html>